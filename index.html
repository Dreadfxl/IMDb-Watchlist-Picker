<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IMDb Watchlist Picker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent: #6558f5;
      --accent-alt: #72e4e2;
      --bg1: #f7f8fa;
      --bg2: #f5edfa;
      --fg: #1a1d22;
      --glass: rgba(255, 255, 255, 0.92);
      --border: #ececec;
      --gradient: linear-gradient(120deg, #6a5af9 0%, #72e4e2 100%);
    }
    body {
      background: var(--gradient), var(--bg2);
      background-attachment: fixed;
      min-height: 100vh; margin: 0; padding: 0;
      color: var(--fg);
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      letter-spacing: 0.01em;
      transition: background 0.3s, color 0.4s;
    }
    .container {
      max-width: 440px;
      margin: 5vh auto 0 auto;
      background: var(--glass);
      backdrop-filter: blur(12px) saturate(1.2);
      -webkit-backdrop-filter: blur(12px) saturate(1.2);
      padding: 2.5em 2.2em 2.7em 2.2em;
      border-radius: 22px;
      box-shadow: 0 8px 36px 0 rgba(80, 70, 240, 0.13), 0 1.5px 12px 0 rgba(0,0,0,0.03);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 62vh;
    }
    h1 {
      font-weight: 800;
      font-size: 1.68em;
      margin: 0 0 0.32em;
      letter-spacing: 0.03em;
      background: var(--gradient);
      color: transparent;
      background-clip: text;
      -webkit-background-clip: text;
    }
    .upload-section {
      margin: 2.4em 0 1.3em;
      width: 100%;
      text-align: center;
    }
    .file-upload {
      position: relative; display: inline-block; width: 100%; text-align: center;
    }
    .file-upload input[type="file"] {
      opacity: 0; width: 240px; max-width: 99%; height: 48px;
      position: absolute; left: 0; top: 0; cursor: pointer;
    }
    .upload-label {
      display: inline-block; background: var(--accent);
      color: #fff; border-radius: 10px; padding: 0.82em 1.45em;
      font-weight: 600; font-size: 1.07em; border: none; cursor: pointer;
      letter-spacing: .01em; transition: background 0.19s, box-shadow 0.14s;
      box-shadow: 0 1.5px 9px 0 rgba(130,120,220,0.04);
    }
    .upload-label:hover, .upload-label:focus {
      background: #5548d6;
      box-shadow:0 5px 12px 0 rgba(100,90,230,0.11);
    }
    #darkSwitch {
      position: absolute; right: 30px; top: 32px;
      background: #f8f5ff;
      border: none; border-radius: 50%; width: 46px; height: 46px;
      box-shadow: 0 1px 8px 0 rgba(0,0,0,0.07);
      cursor: pointer; font-size: 1.25em; transition: background 0.2s;
      display: flex; align-items: center; justify-content: center;
      color: #735ae6;
      outline: none;
      z-index: 50;
    }
    #darkSwitch:hover {
      background: #efe6ff;
    }
    #result {
      margin: 1.35em 0 0.7em; text-align: left; color: #607; min-height: 1.2em;
      width: 100%;
      max-width: 380px;
      word-break: break-word;
    }
    #poster {
      max-width: clamp(180px, 65vw, 330px);
      margin: 0.8em auto 0 auto;
      border-radius: 19px;
      box-shadow: 0 7px 28px 0 rgba(76,63,155, 0.13), 0 0.5px 9px 0 rgba(0,0,0,0.03);
      display: block;
      background: rgba(170,170,190,0.1);
      transition: box-shadow 0.13s, outline 0.12s;
    }
    #tryAnother {
      margin: 2.1em auto 0 auto; display: block;
      background: var(--accent-alt);
      color: #fff; border: none;
      padding: 1.07em 2.3em;
      font-weight: 650;
      border-radius: 11px;
      font-size: 1.09em;
      letter-spacing: .03em;
      cursor: pointer;
      box-shadow: 0 2.5px 16px 0 rgba(90,150,160,0.09);
      transition: background 0.14s, color 0.16s, transform 0.12s;
    }
    #tryAnother:hover, #tryAnother:focus {
      background: #6a5af9;
      color: #f7f8fa;
      transform: translateY(-1px) scale(1.04);
    }
    .links-row {
      margin-top: 1.2em;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      font-size: 1.03em;
    }
    .links-row a {
      padding: .36em 1em;
      border-radius: 7px;
      background: linear-gradient(110deg, #ededfa 50%, #f2fffa 100%);
      font-weight: 600;
      color: #6657ff;
      text-decoration: none;
      border: 1.5px solid #eceafc;
      box-shadow: 0 1.5px 4px 0 rgba(120,110,220,0.04);
      transition: box-shadow .18s, background .16s;
      display:inline-block;
    }
    .links-row a:hover, .links-row a:focus {
      background: var(--accent-alt);
      color: #fff;
      box-shadow: 0 2px 8px 0 rgba(80,120,170,0.10);
    }
    @media (max-width: 650px) {
      .container { max-width: 99vw; box-shadow: none; border-radius: 13px; padding: 1.2em 0.8em 2.3em 0.8em;}
      #poster { max-width: 99vw; }
      #result { max-width: 98vw; font-size:1em;}
      #darkSwitch {right: 14px; top: 15px;}
    }
    /* Dark mode overrides */
    body.dark {
      --bg1: #10101a;
      --bg2: #171627;
      --glass: rgba(32,30,52,0.97);
      --border: #21212b;
      --fg: #faf8fc;
      --gradient: linear-gradient(120deg, #20229b 0%, #2adadf 100%);
      color: var(--fg);
    }
    body.dark .container {
      box-shadow: 0 4px 32px 0 rgba(36,35,75,.16) !important;
      border:1.4px solid #24214a;
      background:var(--glass);
      color: #fafafe;
    }
    body.dark #result, body.dark .links-row a {
      color: #d6d7f5;
      background: rgba(80,80,140,0.09);
      border-color: #252254;
    }
    body.dark #poster { background: #23194e !important; }
    body.dark .upload-label,
    body.dark #tryAnother { background: #251ba3;}
    body.dark #tryAnother:hover,.dark #tryAnother:focus { background: #67abe9; color: #07101a;}
    body.dark h1 {
      background: linear-gradient(140deg,#2adadf 30%, #846bfc 100%);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }
  </style>
</head>
<body>
  <button id="darkSwitch" title="Switch theme" aria-label="Theme toggle">🌒</button>
  <div class="container">
    <h1>IMDb Watchlist Picker</h1>
    <div class="upload-section">
      <div class="file-upload">
        <label for="csvUpload" class="upload-label">Upload CSV file</label>
        <input type="file" id="csvUpload" accept=".csv"/>
      </div>
    </div>
    <div id="result"></div>
    <img id="poster" style="display:none" alt="Poster" />
    <button id="tryAnother" style="display:none">Try Another</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ---- THEME ----
    const root = document.documentElement;
    const darkSwitch = document.getElementById('darkSwitch');
    function setTheme(isDark){
      if(isDark){ document.body.classList.add('dark'); darkSwitch.innerText = "☀️"; }
      else { document.body.classList.remove('dark'); darkSwitch.innerText = "🌒"; }
      localStorage.setItem('imdbwlp-theme', isDark ? 'dark':'light');
    }
    // Auto-init from prefers or prior
    let prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(localStorage.getItem('imdbwlp-theme')) prefersDark = localStorage.getItem('imdbwlp-theme') === "dark";
    setTheme(prefersDark);
    darkSwitch.onclick = e => setTheme(!document.body.classList.contains('dark'));

    // ---- MAIN LOGIC ----
    let globalImdbIds = [];
    function tryRandomPoster(attempts = 10) {
      if (!globalImdbIds.length) {
        document.getElementById('result').innerText = 'No movies found in CSV.';
        document.getElementById('poster').style.display = 'none';
        document.getElementById('tryAnother').style.display = 'none';
        return;
      }
      const tried = new Set();
      function pickAndTry(nth) {
        if (tried.size >= Math.min(attempts, globalImdbIds.length)) {
          document.getElementById('result').innerText = 'No posters found for any titles in your list.';
          document.getElementById('poster').style.display = 'none';
          document.getElementById('tryAnother').style.display = 'block';
          return;
        }
        let idx;
        do {
          idx = Math.floor(Math.random() * globalImdbIds.length);
        } while (tried.has(idx) && tried.size < globalImdbIds.length);
        tried.add(idx);

        const imdbId = globalImdbIds[idx];
        document.getElementById('result').innerText = `Trying: ${imdbId}`;
        const tmdbKey = "72357177e7cf80085610bb1f10cae476";
        fetch(`https://api.themoviedb.org/3/find/${imdbId}?api_key=${tmdbKey}&language=en-US&external_source=imdb_id`)
          .then(resp => resp.json())
          .then(data => {
            let tmdbId=null, posterPath='', title='', year='', overview='';
            if (data.movie_results && data.movie_results.length) {
              const m = data.movie_results[0];
              tmdbId = m.id; posterPath = m.poster_path; title = m.title || m.original_title; year = m.release_date?.slice(0,4); overview = m.overview;
            } else if (data.tv_results && data.tv_results.length) {
              const t = data.tv_results[0];
              tmdbId = t.id; posterPath = t.poster_path; title = t.name || t.original_name; year = t.first_air_date?.slice(0,4); overview = t.overview;
            }
            if (!tmdbId|| !posterPath) return pickAndTry(nth+1);

            fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${tmdbKey}&language=en-US`)
              .then(resp2 => resp2.json())
              .then(details => {
                const genres = (details.genres||[]).map(g=>g.name).join(', ');
                const rating = details.vote_average !== undefined ? (details.vote_average.toFixed(1) + ' / 10') : 'N/A';
                const votes = details.vote_count ? ` (${details.vote_count.toLocaleString()} votes)` : '';
                const imdbUrl = `https://www.imdb.com/title/${imdbId}/`;
                const tmdbUrl = `https://www.themoviedb.org/movie/${tmdbId}`;
                const letterboxdUrl = `https://letterboxd.com/imdb/${imdbId}/`;
                const rtUrl = `https://www.rottentomatoes.com/search?search=${encodeURIComponent(title)}`;
                const mcUrl = `https://www.metacritic.com/search/${encodeURIComponent(title)}`;
                let html = `
              <div style="margin-bottom:1.1em;margin-top:-0.4em;text-align:left;display:flex;flex-direction:column;align-items:center;">
                <div style="font-size:1.3em;font-weight:800;color:#333;margin-bottom:2px;letter-spacing:0.01em">
                  <span style="background:var(--gradient);background-clip:text;-webkit-background-clip:text;color:transparent;">
                  ${title}</span>
                  <span style="font-weight:400;color:#62e5e2;font-size:0.91em;margin-left:0.18em">${year}</span>
                </div>
                <div style="font-size:1.09em; color:#6a54db;margin:2px 0 7px 0">${genres}</div>
                <div style="margin:0.16em 0 0.38em 0;color:#6badf6;font-weight:700;">TMDB: ${rating}${votes}</div>
                <div style="font-size:1.01em;color:#22223bda;line-height:1.52;margin-top:3px">${overview}</div>
                <div class="links-row">
                  <a href="${imdbUrl}" target="_blank" rel="noopener">IMDb</a>
                  <a href="${tmdbUrl}" target="_blank" rel="noopener">TMDB</a>
                  <a href="${letterboxdUrl}" target="_blank" rel="noopener">Letterboxd</a>
                  <a href="${rtUrl}" target="_blank" rel="noopener">RT</a>
                  <a href="${mcUrl}" target="_blank" rel="noopener">Metacritic</a>
                </div>
              </div>
                `;
                document.getElementById('result').innerHTML = html;
                const posterImg = document.getElementById('poster');
                posterImg.onerror = function() {
                  posterImg.style.display = 'none';
                  pickAndTry(nth + 1);
                };
                posterImg.onload = function() {
                  posterImg.style.display = 'block';
                  document.getElementById('tryAnother').style.display = 'block';
                };
                posterImg.src = `https://image.tmdb.org/t/p/w500${posterPath}`;
              }).catch(()=> pickAndTry(nth+1));
          }).catch(()=> pickAndTry(nth+1));
      }
      pickAndTry(0);
    }
    document.getElementById('csvUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          globalImdbIds = results.data
            .map(row => row['Const'] && row['Const'].trim())
            .filter(id => id && /^tt\d+$/.test(id));
          document.getElementById('tryAnother').style.display = globalImdbIds.length ? 'block' : 'none';
          tryRandomPoster();
        }
      });
    });
    document.getElementById('tryAnother').onclick = () => tryRandomPoster();
    document.querySelector('.upload-label').addEventListener('click', function() {
      document.getElementById('csvUpload').click();
    });
  </script>
</body>
</html>

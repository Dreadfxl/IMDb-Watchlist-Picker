<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IMDb Watchlist Picker</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    #poster { max-width: 300px; margin-top: 2em; }
    .upload-section { margin: 2em 0; }
  </style>
</head>
<body>
  <h1>IMDb Watchlist Picker</h1>
  <div class="upload-section">
    <label for="csvUpload">Upload your IMDb watchlist CSV file:</label>
    <input type="file" id="csvUpload" accept=".csv" />
  </div>
  <div id="result"></div>
  <img id="poster" style="display:none" />

<script>
document.getElementById('csvUpload').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();

  reader.onload = function(e) {
    const text = e.target.result;
    // Parse CSV, get all IMDb IDs in Const column (usually 2nd column)
    const rows = text.split('\n').slice(1).filter(row => row && !/^,\s*$/.test(row));
    const imdbIds = rows.map(row => {
      const cols = row.split(',');
      // IMDb ID may have quotes, remove them
      return cols[1] ? cols[1].replace(/"/g, '').trim() : null;
    }).filter(Boolean);
    if (!imdbIds.length) {
      document.getElementById('result').innerText = 'No movies found in CSV.';
      document.getElementById('poster').style.display = 'none';
      return;
    }
    // Pick random movie
    const randomId = imdbIds[Math.floor(Math.random() * imdbIds.length)];
    document.getElementById('result').innerText = `Random IMDb ID: ${randomId}`;
    // Fetch poster from RPDB
    fetch(`https://api.ratingposterdb.com/${randomId}?apikey=t0-free-rpdb`)
      .then(resp => resp.json())
      .then(data => {
        const posterUrl = data.poster_url || data.posterUrl || '';
        if (posterUrl) {
          const posterImg = document.getElementById('poster');
          posterImg.src = posterUrl;
          posterImg.style.display = 'block';
        } else {
          document.getElementById('poster').style.display = 'none';
        }
      })
      .catch(() => {
        document.getElementById('result').innerText = 'Poster lookup failed.';
        document.getElementById('poster').style.display = 'none';
      });
  };
  reader.readAsText(file);
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IMDb Watchlist Picker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent: #6558f5;
      --accent-light: #edeafd;
      --bg: #f7f8fa;
      --fg: #22223b;
      --border: #e2e2e2;
    }
    html, body {
      padding: 0; margin: 0;
      background: var(--bg);
      min-height: 100vh;
      color: var(--fg);
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      font-size: 17px;
      letter-spacing: 0.01em;
    }
    .container {
      max-width: 420px;
      margin: 4vh auto 0 auto;
      background: white;
      padding: 2em 2em 2.5em 2em;
      border-radius: 18px;
      box-shadow: 0 8px 28px 0 rgba(30,34,90, 0.11);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 60vh;
    }
    h1 {
      font-weight: 700;
      font-size: 1.6em;
      margin: 0 0 0.5em;
      letter-spacing: 0.03em;
      color: var(--accent);
    }
    .upload-section {
      margin: 2em 0 1em;
      width: 100%;
      text-align: center;
    }
    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
      text-align: center;
    }
    .file-upload input[type="file"] {
      opacity: 0;
      width: 220px; max-width: 100%;
      height: 48px;
      position: absolute;
      left: 0;
      top: 0;
      cursor: pointer;
    }
    .upload-label {
      display: inline-block;
      background: var(--accent);
      color: white;
      border-radius: 8px;
      padding: 0.8em 1.4em;
      font-weight: 500;
      font-size: 1.06em;
      border: none;
      cursor: pointer;
      letter-spacing: 0.01em;
      transition: background 0.15s;
      box-shadow: 0 2px 8px 0 rgba(100,100,200,0.02);
    }
    .upload-label:hover, .upload-label:focus {
      background: #5448d6;
    }
    #result {
      margin: 1.2em 0 0.7em;
      text-align: center;
      color: #6a6a8f;
      min-height: 1.2em;
    }
    #poster {
      max-width: clamp(240px, 65vw, 320px);
      margin: 1.2em auto 0 auto;
      border-radius: 14px;
      box-shadow: 0 3px 16px 0 rgba(60,70,150,0.11);
      display: block;
      background: #ececf6;
      transition: box-shadow 0.13s, outline 0.12s;
    }
    #tryAnother {
      margin: 2em auto 0 auto;
      display: block;
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.95em 2.1em;
      font-weight: 600;
      border-radius: 9px;
      font-size: 1em;
      letter-spacing: 0.03em;
      cursor: pointer;
      box-shadow: 0 2px 12px 0 rgba(60,60,160,0.065);
      outline: none;
      transition: background 0.17s, transform 0.12s;
    }
    #tryAnother:hover, #tryAnother:focus {
      background: #4b42c8;
      transform: translateY(-1px) scale(1.035);
    }
    @media (max-width: 650px) {
      .container { box-shadow: none; border-radius:8px; padding: 1.2em 0.7em 2em 0.7em;}
      #poster { max-width: 96vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>IMDb Watchlist Picker</h1>
    <div class="upload-section">
      <div class="file-upload">
        <label for="csvUpload" class="upload-label">Upload CSV file</label>
        <input type="file" id="csvUpload" accept=".csv"/>
      </div>
    </div>
    <div id="result"></div>
    <img id="poster" style="display:none" alt="Poster" />
    <button id="tryAnother" style="display:none">Try Another</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let globalImdbIds = [];
    function tryRandomPoster(attempts = 10) {
      if (!globalImdbIds.length) {
        document.getElementById('result').innerText = 'No movies found in CSV.';
        document.getElementById('poster').style.display = 'none';
        document.getElementById('tryAnother').style.display = 'none';
        return;
      }
      const tried = new Set();
      function pickAndTry(nth) {
  if (tried.size >= Math.min(attempts, globalImdbIds.length)) {
    document.getElementById('result').innerText = 'No posters found for any titles in your list.';
    document.getElementById('poster').style.display = 'none';
    document.getElementById('tryAnother').style.display = 'block';
    return;
  }
  let idx;
  do {
    idx = Math.floor(Math.random() * globalImdbIds.length);
  } while (tried.has(idx) && tried.size < globalImdbIds.length);
  tried.add(idx);
  const imdbId = globalImdbIds[idx];
  document.getElementById('result').innerText = `Trying: ${imdbId}`;
  const tmdbKey = "72357177e7cf80085610bb1f10cae476";
  fetch(`https://api.themoviedb.org/3/find/${imdbId}?api_key=${tmdbKey}&language=en-US&external_source=imdb_id`)
    .then(resp => resp.json())
    .then(data => {
      let tmdbId=null, posterPath='', title='', year='', overview='';
      if (data.movie_results && data.movie_results.length) {
        const m = data.movie_results[0];
        tmdbId = m.id; posterPath = m.poster_path; title = m.title || m.original_title; year = m.release_date?.slice(0,4); overview = m.overview;
      } else if (data.tv_results && data.tv_results.length) {
        const t = data.tv_results[0];
        tmdbId = t.id; posterPath = t.poster_path; title = t.name || t.original_name; year = t.first_air_date?.slice(0,4); overview = t.overview;
      }
      if (!tmdbId|| !posterPath) return pickAndTry(nth+1);

      // details fetch for genres, rating etc.
      fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${tmdbKey}&language=en-US`)
        .then(resp2 => resp2.json())
        .then(details => {
          // Build card
          const genres = (details.genres||[]).map(g=>g.name).join(', ');
          const rating = details.vote_average !== undefined ? (details.vote_average.toFixed(1) + ' / 10') : 'N/A';
          const votes = details.vote_count ? ` (${details.vote_count} votes)` : '';

          // Build hyperlinks
          const imdbUrl = `https://www.imdb.com/title/${imdbId}/`;
          const tmdbUrl = `https://www.themoviedb.org/movie/${tmdbId}`;
          const letterboxdUrl = `https://letterboxd.com/imdb/${imdbId}/`;
          const rtUrl = `https://www.rottentomatoes.com/search?search=${encodeURIComponent(title)}`;
          const mcUrl = `https://www.metacritic.com/search/all/${encodeURIComponent(title)}/results`;

          let html = `
            <div style="margin-bottom:1.2em">
              <div style="font-size:1.25em;font-weight:600">${title} <span style="font-weight:300;color:#aaa;">${year || ''}</span></div>
              <div style="font-size:1em;color:#666">${genres}</div>
              <div style="margin:0.4em 0;color:#935fff;font-weight:500">TMDB Rating: ${rating}${votes}</div>
              <div style="font-size:0.97em;color:#313">${overview||''}</div>
              <div style="margin-top:0.7em;display:flex;gap:10px;flex-wrap:wrap">
                <a href="${imdbUrl}" target="_blank" rel="noopener" style="color:#312ddb;text-decoration:none;font-weight:500">IMDb</a>
                <a href="${tmdbUrl}" target="_blank" rel="noopener" style="color:#10a37f;text-decoration:none;font-weight:500">TMDB</a>
                <a href="${letterboxdUrl}" target="_blank" rel="noopener" style="color:#000;text-decoration:none;font-weight:500">Letterboxd</a>
                <a href="${rtUrl}" target="_blank" rel="noopener" style="color:#0d7c29;text-decoration:none;font-weight:500">Rotten Tomatoes</a>
                <a href="${mcUrl}" target="_blank" rel="noopener" style="color:#dc143c;text-decoration:none;font-weight:500">Metacritic</a>
              </div>
            </div>
          `;
          document.getElementById('result').innerHTML = html;
          const posterImg = document.getElementById('poster');
          posterImg.onerror = function() {
            posterImg.style.display = 'none';
            pickAndTry(nth + 1);
          };
          posterImg.onload = function() {
            posterImg.style.display = 'block';
            document.getElementById('tryAnother').style.display = 'block';
          };
          posterImg.src = `https://image.tmdb.org/t/p/w500${posterPath}`;
        }).catch(()=> pickAndTry(nth+1));
    }).catch(()=> pickAndTry(nth+1));
}

    document.getElementById('csvUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          globalImdbIds = results.data
            .map(row => row['Const'] && row['Const'].trim())
            .filter(id => id && /^tt\d+$/.test(id));
          document.getElementById('tryAnother').style.display = globalImdbIds.length ? 'block' : 'none';
          tryRandomPoster();
        }
      });
    });
    document.getElementById('tryAnother').onclick = () => tryRandomPoster();

    // Make clicking the upload label open the file dialog
    document.querySelector('.upload-label').addEventListener('click', function() {
      document.getElementById('csvUpload').click();
    });
  </script>
</body>
</html>

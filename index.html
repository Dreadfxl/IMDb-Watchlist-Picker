<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IMDb Watchlist Picker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent: #604bf5;
      --accent-muted: #dad7fc;
      --bg-light: #f7f8fa;
      --bg-dark: #181926;
      --card-light: #fff;
      --card-dark: #23243a;
      --text-light: #181926;
      --text-dark: #efeff4;
      --border-light: #ecedf8;
      --border-dark: #252638;
      --shadow: 0 6px 32px 0 rgba(44,40,77,0.09), 0 1.5px 7px 0 rgba(0,0,0,0.02);
    }
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.32s, color 0.28s;
    }
    .dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .main {
      max-width: 430px;
      margin: 6vh auto 0 auto;
      padding: 0 0.7em 2.8em 0.7em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-weight: 800; font-size: 1.52em;
      margin: 0 0 1.7em 0;
      letter-spacing: 0.025em;
      color: var(--accent);
    }
    .card {
      width: 100%;
      background: var(--card-light);
      color: var(--text-light);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 2.2em 2em 2em;
      border: 1.2px solid var(--border-light);
      margin-bottom: 2.6em;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background .35s, color .25s, border .25s;
    }
    .dark .card {
      background: var(--card-dark);
      color: var(--text-dark);
      border-color: var(--border-dark);
    }
    .upload-label {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      border-radius: 8px;
      padding: 0.85em 1.5em;
      font-weight: 600;
      font-size: 1.04em;
      border: none;
      cursor: pointer;
      letter-spacing: .01em;
      transition: background .15s, box-shadow .12s;
      margin-bottom: 2em;
      box-shadow: 0 2px 6px 0 rgba(80,70,180,0.06);
    }
    .upload-label:hover, .upload-label:focus {
      background: #4030af;
    }
    .file-upload input[type="file"] { display: none; }
    #darkSwitch {
      position: fixed;
      right: 28px;
      top: 24px;
      z-index: 20;
      background: transparent;
      border: none;
      font-size: 1.3em;
      color: #abacfd;
      cursor: pointer;
      outline: none;
      transition: color 0.15s;
    }
    #darkSwitch:active { color: #836bfc; }
    .movie-poster {
      width: 220px; min-width: 160px; max-width: 99%;
      border-radius: 15px;
      box-shadow: 0 5px 32px 0 rgba(44,40,77,.095), 0 1.5px 9px 0 rgba(0,0,0,0.04);
      background: #ebedf2;
      object-fit: cover;
      margin: 0 auto 1.5em auto;
      display: block;
      border: 1px solid var(--border-light);
      transition: border 0.23s;
    }
    .dark .movie-poster { background: #23243a; border-color: #242638; }
    .movie-title {
      font-weight: 700;
      font-size: 1.23em;
      margin-bottom: 0.10em;
      text-align:center;
      color: var(--accent);
      letter-spacing:0.01em;
    }
    .movie-meta, .movie-rating, .movie-genre, .movie-year {
      width: 100%;
      text-align: center;
      margin: 0.19em 0;
    }
    .movie-genre { color: #8082ad; font-weight: 500;}
    .movie-year  { color: #bbbcdc; font-size:.98em;}
    .movie-rating {
      color: #ffab36;
      margin-top: 0.15em;
      font-weight: 600;
      font-size: 1.1em;
    }
    .movie-desc {
      color: #4f5081; 
      font-size:1.01em; 
      text-align: center;
      letter-spacing:0.013em;
      line-height: 1.56;
      margin: 0.5em 0 1.15em 0;
      min-height: 2.09em;
    }
    .dark .movie-desc { color: #b2bed4;}
    .platform-links {
      display: flex;
      gap: 13px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 0.5em;
    }
    .platform-links a {
      background: var(--accent-muted);
      color: #5545b8;
      border-radius: 6px;
      font-weight: 500;
      font-size: .99em;
      text-decoration: none;
      padding: .34em 1.05em .38em 1.05em;
      transition: background .13s, color .13s;
    }
    .platform-links a:hover, .platform-links a:focus {
      background: var(--accent);
      color: #fff;
    }
    #tryAnother {
      margin: 0.5em auto 0 auto;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: .97em 2.2em;
      font-weight: 650;
      border-radius: 8px;
      font-size: 1.06em;
      letter-spacing: .03em;
      cursor: pointer;
      transition: background .14s;
      box-shadow: 0 1.5px 10px 0 rgba(76,96,255,0.058);
    }
    #tryAnother:hover, #tryAnother:focus {
      background: #4030af;
      color: #fff;
    }
    #result {
      min-height:1.4em;
      margin-bottom:.8em;
    }
    @media (max-width: 500px) {
      .main { padding: 0 0.2em;}
      .card { padding: 1.4em 0.4em 1.5em;}
    }
  </style>
</head>
<body>
  <button id="darkSwitch" title="Switch theme" aria-label="Theme toggle">ðŸŒ’</button>
  <div class="main">
    <h1>IMDb Watchlist Picker</h1>
    <div class="file-upload">
      <label for="csvUpload" class="upload-label">Upload CSV file</label>
      <input type="file" id="csvUpload" accept=".csv"/>
    </div>
    <div id="result"></div>
    <div id="movieCard" class="card" style="display:none"></div>
    <button id="tryAnother" style="display:none">Try Another</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Theme logic
    const darkSwitch = document.getElementById('darkSwitch');
    function setTheme(isDark){
      document.body.classList.toggle('dark', isDark);
      darkSwitch.innerText = isDark ? "â˜€ï¸" : "ðŸŒ’";
      localStorage.setItem('imdbwlp-theme', isDark ? 'dark':'light');
    }
    let prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(localStorage.getItem('imdbwlp-theme')) prefersDark = localStorage.getItem('imdbwlp-theme') === "dark";
    setTheme(prefersDark);
    darkSwitch.onclick = e => setTheme(!document.body.classList.contains('dark'));

    // Main logic
    let globalImdbIds = [];
    function tryRandomPoster(attempts = 10) {
      document.getElementById('movieCard').style.display = "none";
      const resultDiv = document.getElementById("result");
      if (!globalImdbIds.length) {
        resultDiv.innerText = 'No movies found in CSV.';
        document.getElementById('tryAnother').style.display = 'none';
        return;
      }
      const tried = new Set();
      function pickAndTry(nth) {
        if (tried.size >= Math.min(attempts, globalImdbIds.length)) {
          resultDiv.innerText = 'No posters found for any titles in your list.';
          document.getElementById('tryAnother').style.display = 'block';
          return;
        }
        let idx;
        do {
          idx = Math.floor(Math.random() * globalImdbIds.length);
        } while (tried.has(idx) && tried.size < globalImdbIds.length);
        tried.add(idx);

        const imdbId = globalImdbIds[idx];
        resultDiv.innerText = `...`;
        const tmdbKey = "72357177e7cf80085610bb1f10cae476";
        fetch(`https://api.themoviedb.org/3/find/${imdbId}?api_key=${tmdbKey}&language=en-US&external_source=imdb_id`)
          .then(resp => resp.json())
          .then(data => {
            let tmdbId=null, posterPath='', title='', year='', overview='';
            if (data.movie_results && data.movie_results.length) {
              const m = data.movie_results[0];
              tmdbId = m.id; posterPath = m.poster_path; title = m.title || m.original_title; year = m.release_date?.slice(0,4); overview = m.overview;
            } else if (data.tv_results && data.tv_results.length) {
              const t = data.tv_results[0];
              tmdbId = t.id; posterPath = t.poster_path; title = t.name || t.original_name; year = t.first_air_date?.slice(0,4); overview = t.overview;
            }
            if (!tmdbId|| !posterPath) return pickAndTry(nth+1);

            fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${tmdbKey}&language=en-US`)
              .then(resp2 => resp2.json())
              .then(details => {
                const genres = (details.genres||[]).map(g=>g.name).join(', ');
                const rating = details.vote_average !== undefined ? (details.vote_average.toFixed(1) + ' / 10') : 'N/A';
                const votes = details.vote_count ? ` (${details.vote_count.toLocaleString()} votes)` : '';
                const imdbUrl = `https://www.imdb.com/title/${imdbId}/`;
                const tmdbUrl = `https://www.themoviedb.org/movie/${tmdbId}`;
                const letterboxdUrl = `https://letterboxd.com/imdb/${imdbId}/`;
                const rtUrl = `https://www.rottentomatoes.com/search?search=${encodeURIComponent(title)}`;
                const mcUrl = `https://www.metacritic.com/search/${encodeURIComponent(title)}`;

                document.getElementById('movieCard').innerHTML = `
                  <img class="movie-poster" src="https://image.tmdb.org/t/p/w500${posterPath}" 
                    onerror="this.style.display='none'" alt="${title} poster"/>
                  <div class="movie-title">${title}</div>
                  <div class="movie-year">${year}</div>
                  <div class="movie-genre">${genres}</div>
                  <div class="movie-rating">TMDB: ${rating}${votes}</div>
                  <div class="movie-desc">${overview || ''}</div>
                  <div class="platform-links">
                      <a href="${imdbUrl}" target="_blank" rel="noopener">IMDb</a>
                      <a href="${tmdbUrl}" target="_blank" rel="noopener">TMDB</a>
                      <a href="${letterboxdUrl}" target="_blank" rel="noopener">Letterboxd</a>
                      <a href="${rtUrl}" target="_blank" rel="noopener">RT</a>
                      <a href="${mcUrl}" target="_blank" rel="noopener">Metacritic</a>
                  </div>
                `;
                document.getElementById('movieCard').style.display = "flex";
                resultDiv.innerText = "";
                document.getElementById('tryAnother').style.display = 'block';
              }).catch(()=> pickAndTry(nth+1));
          }).catch(()=> pickAndTry(nth+1));
      }
      pickAndTry(0);
    }
    document.getElementById('csvUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          globalImdbIds = results.data
            .map(row => row['Const'] && row['Const'].trim())
            .filter(id => id && /^tt\d+$/.test(id));
          document.getElementById('tryAnother').style.display = globalImdbIds.length ? 'block' : 'none';
          tryRandomPoster();
        }
      });
    });
    document.getElementById('tryAnother').onclick = () => tryRandomPoster();
    document.querySelector('.upload-label').addEventListener('click', function() {
      document.getElementById('csvUpload').click();
    });
  </script>
</body>
</html>
